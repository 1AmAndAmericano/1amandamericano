<!DOCTYPE html>
<html>
<head>
<title><%= title %></title>
</head>
<body>
<h1><%= title %></h1>
<p>Welcome to Manager make reservation </p>
<a href="/">Home</a>
<a href="/list">Reservation list</a>
<a href="/logout">logout</a>

<form action="/make_resv" method="post" id="myform">
    <table>
        <td>
            from : <input type="date" placeholder="2017-01-01" id="fromday" name="from"/><br>
        </td>

        <td>
            to : <input type="date" placeholder="2017-01-01" id="today" name="to"/><br>
        </td>

        <td>
            What kinds of room
            <select name="room_type">
                <option disabled selected value> -- </option>
                <option value="single">Single</option>
                <option value="double">Double</option>
                <option value="twin">Twin</option>
                <option value="special">Special</option>
            </select><br>
        </td>

        <td>
            Guests
            <input type="number" name="guests" value="1"/><br>
        </td>

        <td>
			<button id="search">MAKE</button>
        </td>
    </table>
</form>

<strong>Filtered by</strong> <font id="filter"><%= filter %></font><br>


<table id="rev_list">
    <tr>
        <th>RoomNumber</th>
        <th>RoomPrice</th>
        <th>RoomType</th>
        <th>MAKE</th>
    </tr>
</table>
<script>
    document.getElementById("search").addEventListener("click", function () {
            var fromday = document.getElementById("fromday").value;	
            var today = document.getElementById("today").value;	
            if(new Date(fromday).getTime() <= new Date(today).getTime()){
                var form = document.getElementById("myform");
                form.submit();
            }else {
                alert("Check-in date should be earlier than Check-out date");
            }
        });
    var table = document.getElementById("rev_list");
    var data = '<%- data %>';
    var row;
    var cell0, cell1, cell2, cell3;
    var filted_data = document.getElementById("filter").textContent;
    var d;
    data = JSON.parse(data);
    console.log(data);
    for(var i in data){
        d = data[i];
        row = table.insertRow(-1);
        cell0 = row.insertCell(0);
        cell1 = row.insertCell(1);
        cell2 = row.insertCell(2);
        cell3 = row.insertCell(3);
        cell0.innerHTML = d.RoomNumber;
        cell1.innerHTML = d.RoomPrice;
        cell2.innerHTML = d.RoomType;
        cell3.innerHTML = '<button onclick="inputEmail(this,filted_data)">Make</button>';
    
    }
    function inputEmail(el, filted_data){
        var RoomNumber = el.parentNode.parentNode.cells[0].textContent;
        var RoomPrice = el.parentNode.parentNode.cells[1].textContent;
        var RoomType = el.parentNode.parentNode.cells[2].textContent;
        console.log(RoomNumber);
        console.log(RoomPrice);
        console.log(RoomType);
        var other_data = prompt("Email/Bank/Account", "user@gmail.com/woori/1002");
        if (other_data.split('/').length==3){
            post_to_url({'RoomNumber': RoomNumber, 'RoomPrice':RoomPrice, 'RoomType': RoomType, 'other_data':other_data, 'data' : filted_data});
            alert("Reservation Complete");
        }else {
            alert("Invalid data form. Try again");
        }

    }

    function post_to_url(params) {
        var form = document.createElement("form");
        form.setAttribute("method", "post");
        form.setAttribute("action", "/insertdb");
        for(var key in params) {
            var data = document.createElement("input");
            data.setAttribute("type", "hidden");
            data.setAttribute("name", key);
            data.setAttribute("value", params[key]);
            form.appendChild(data);
        }
        document.body.appendChild(form);
        form.submit();
    }

</script>
</body>
</html>
